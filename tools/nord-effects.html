<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nord Effects Controller - MIDI Tools</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    
    <style>
        .controls-section {
            padding: 20px;
        }
        
        .device-group {
            margin-bottom: 20px;
        }
        
        .device-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .device-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }
        
        .effect-group {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .effect-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .control-row label {
            min-width: 120px;
            font-weight: 500;
        }
        
        .control-row input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .control-row input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .control-row .value-display {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
        }
        
        .toggle-button {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .toggle-button.active {
            background: #667eea;
            color: white;
        }
        
        .toggle-button:hover {
            transform: scale(1.05);
        }
        
        .midi-status {
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            margin: 20px;
        }
        
        .midi-status.connected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-btn {
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .preset-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .back-navigation {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1>üéöÔ∏è Nord Effects Controller</h1>
                    <p>Control your Nord keyboard effects via MIDI CC</p>
                </div>
            </div>
        </header>

        <main>
            <div class="back-navigation">
                <button id="backBtn" class="btn btn-secondary">‚Üê Back to Tools</button>
            </div>

            <div class="midi-status" id="midiStatus">
                <strong>MIDI Status:</strong> <span id="statusText">Initializing...</span>
            </div>

            <div class="controls-section">
                <section class="device-group">
                    <label for="midiOutput">MIDI Output Device:</label>
                    <select id="midiOutput">
                        <option value="">No device selected</option>
                    </select>
                </section>

                <!-- Rotary Speaker -->
                <div class="effect-group">
                    <h3>üîÑ Rotary Speaker</h3>
                    <div class="control-row">
                        <label>Speed:</label>
                        <button class="toggle-button" id="rotarySpeed" data-cc="3" data-off="32" data-on="96">
                            Slow
                        </button>
                    </div>
                </div>

                <!-- Reverb -->
                <div class="effect-group">
                    <h3>‚ú® Reverb</h3>
                    <div class="control-row">
                        <label>On/Off:</label>
                        <button class="toggle-button" id="reverbToggle" data-cc="105" data-off="0" data-on="127">
                            Off
                        </button>
                    </div>
                    <div class="control-row">
                        <label>Amount:</label>
                        <input type="range" id="reverbAmount" min="0" max="127" value="64" data-cc="85">
                        <span class="value-display" id="reverbValue">64</span>
                    </div>
                </div>

                <!-- Delay -->
                <div class="effect-group">
                    <h3>üîÅ Delay</h3>
                    <div class="control-row">
                        <label>On/Off:</label>
                        <button class="toggle-button" id="delayToggle" data-cc="104" data-off="0" data-on="127">
                            Off
                        </button>
                    </div>
                    <div class="control-row">
                        <label>Amount:</label>
                        <input type="range" id="delayAmount" min="0" max="127" value="64" data-cc="19">
                        <span class="value-display" id="delayValue">64</span>
                    </div>
                </div>

                <!-- Effect 1 (Tremolo/Pan) -->
                <div class="effect-group">
                    <h3>üåä Effect 1 (Tremolo/Pan)</h3>
                    <div class="control-row">
                        <label>On/Off:</label>
                        <button class="toggle-button" id="effect1Toggle" data-cc="102" data-off="0" data-on="127">
                            Off
                        </button>
                    </div>
                    <div class="control-row">
                        <label>Depth:</label>
                        <input type="range" id="effect1Amount" min="0" max="127" value="64" data-cc="17">
                        <span class="value-display" id="effect1Value">64</span>
                    </div>
                </div>

                <!-- Effect 2 (Phaser/Flanger/Chorus) -->
                <div class="effect-group">
                    <h3>„Ä∞Ô∏è Effect 2 (Phaser/Flanger/Chorus)</h3>
                    <div class="control-row">
                        <label>On/Off:</label>
                        <button class="toggle-button" id="effect2Toggle" data-cc="103" data-off="0" data-on="127">
                            Off
                        </button>
                    </div>
                    <div class="control-row">
                        <label>Depth:</label>
                        <input type="range" id="effect2Amount" min="0" max="127" value="64" data-cc="18">
                        <span class="value-display" id="effect2Value">64</span>
                    </div>
                </div>

                <!-- Piano String Resonance -->
                <div class="effect-group">
                    <h3>üéπ Piano String Resonance</h3>
                    <div class="control-row">
                        <label>Amount:</label>
                        <input type="range" id="resonanceAmount" min="0" max="127" value="64" data-cc="86">
                        <span class="value-display" id="resonanceValue">64</span>
                    </div>
                </div>

                <!-- Presets -->
                <div class="effect-group">
                    <h3>üíæ Quick Presets</h3>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="clean">Clean Piano</button>
                        <button class="preset-btn" data-preset="jazz">Jazz Combo</button>
                        <button class="preset-btn" data-preset="ambient">Ambient Pad</button>
                        <button class="preset-btn" data-preset="rock">Rock Organ</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Web MIDI Streamer | <a href="https://github.com/denizsincar29/web_midi_streamer" target="_blank" rel="noopener">GitHub</a></p>
        </footer>
    </div>

    <script type="module">
        let midiAccess = null;
        let selectedOutput = null;

        // Initialize MIDI
        async function initMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                updateMIDIStatus('MIDI Access Granted', true);
                populateOutputDevices();
                midiAccess.onstatechange = populateOutputDevices;
            } catch (error) {
                updateMIDIStatus('MIDI Access Denied: ' + error.message, false);
            }
        }

        function updateMIDIStatus(message, connected) {
            const statusEl = document.getElementById('midiStatus');
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusEl.className = connected ? 'midi-status connected' : 'midi-status';
        }

        function populateOutputDevices() {
            const select = document.getElementById('midiOutput');
            select.innerHTML = '<option value="">No device selected</option>';
            
            const outputs = Array.from(midiAccess.outputs.values());
            outputs.forEach((output, index) => {
                const option = document.createElement('option');
                option.value = output.id;
                option.textContent = output.name;
                if (index === 0) option.selected = true;
                select.appendChild(option);
            });

            // Auto-select first device
            if (outputs.length > 0) {
                selectOutput(outputs[0].id);
            }
        }

        function selectOutput(deviceId) {
            if (deviceId && midiAccess) {
                selectedOutput = midiAccess.outputs.get(deviceId);
                updateMIDIStatus('Connected to: ' + selectedOutput.name, true);
            } else {
                selectedOutput = null;
                updateMIDIStatus('No output device selected', false);
            }
        }

        function sendCC(cc, value) {
            if (selectedOutput) {
                // Send on MIDI channel 1 (0xB0)
                selectedOutput.send([0xB0, cc, value]);
                console.log(`Sent CC ${cc}: ${value}`);
            }
        }

        // Setup toggle buttons
        document.querySelectorAll('.toggle-button').forEach(button => {
            button.addEventListener('click', () => {
                const isActive = button.classList.contains('active');
                const cc = parseInt(button.dataset.cc);
                const offValue = parseInt(button.dataset.off);
                const onValue = parseInt(button.dataset.on);
                
                if (isActive) {
                    button.classList.remove('active');
                    button.textContent = button.id === 'rotarySpeed' ? 'Slow' : 'Off';
                    sendCC(cc, offValue);
                } else {
                    button.classList.add('active');
                    button.textContent = button.id === 'rotarySpeed' ? 'Fast' : 'On';
                    sendCC(cc, onValue);
                }
            });
        });

        // Setup range sliders
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            const valueDisplay = document.getElementById(slider.id.replace('Amount', 'Value'));
            
            slider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                valueDisplay.textContent = value;
                const cc = parseInt(slider.dataset.cc);
                sendCC(cc, value);
            });
        });

        // Preset configurations
        const presets = {
            clean: {
                reverb: { toggle: false, amount: 30 },
                delay: { toggle: false, amount: 0 },
                effect1: { toggle: false, amount: 0 },
                effect2: { toggle: false, amount: 0 },
                resonance: 64
            },
            jazz: {
                reverb: { toggle: true, amount: 60 },
                delay: { toggle: false, amount: 30 },
                effect1: { toggle: false, amount: 0 },
                effect2: { toggle: true, amount: 45 },
                resonance: 80
            },
            ambient: {
                reverb: { toggle: true, amount: 100 },
                delay: { toggle: true, amount: 85 },
                effect1: { toggle: true, amount: 50 },
                effect2: { toggle: true, amount: 60 },
                resonance: 90
            },
            rock: {
                reverb: { toggle: true, amount: 45 },
                delay: { toggle: false, amount: 0 },
                effect1: { toggle: false, amount: 0 },
                effect2: { toggle: false, amount: 0 },
                resonance: 40
            }
        };

        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;

            // Apply reverb
            const reverbToggle = document.getElementById('reverbToggle');
            const reverbAmount = document.getElementById('reverbAmount');
            if (preset.reverb.toggle) {
                reverbToggle.classList.add('active');
                reverbToggle.textContent = 'On';
                sendCC(105, 127);
            } else {
                reverbToggle.classList.remove('active');
                reverbToggle.textContent = 'Off';
                sendCC(105, 0);
            }
            reverbAmount.value = preset.reverb.amount;
            document.getElementById('reverbValue').textContent = preset.reverb.amount;
            sendCC(85, preset.reverb.amount);

            // Apply delay
            const delayToggle = document.getElementById('delayToggle');
            const delayAmount = document.getElementById('delayAmount');
            if (preset.delay.toggle) {
                delayToggle.classList.add('active');
                delayToggle.textContent = 'On';
                sendCC(104, 127);
            } else {
                delayToggle.classList.remove('active');
                delayToggle.textContent = 'Off';
                sendCC(104, 0);
            }
            delayAmount.value = preset.delay.amount;
            document.getElementById('delayValue').textContent = preset.delay.amount;
            sendCC(19, preset.delay.amount);

            // Apply effect 1
            const effect1Toggle = document.getElementById('effect1Toggle');
            const effect1Amount = document.getElementById('effect1Amount');
            if (preset.effect1.toggle) {
                effect1Toggle.classList.add('active');
                effect1Toggle.textContent = 'On';
                sendCC(102, 127);
            } else {
                effect1Toggle.classList.remove('active');
                effect1Toggle.textContent = 'Off';
                sendCC(102, 0);
            }
            effect1Amount.value = preset.effect1.amount;
            document.getElementById('effect1Value').textContent = preset.effect1.amount;
            sendCC(17, preset.effect1.amount);

            // Apply effect 2
            const effect2Toggle = document.getElementById('effect2Toggle');
            const effect2Amount = document.getElementById('effect2Amount');
            if (preset.effect2.toggle) {
                effect2Toggle.classList.add('active');
                effect2Toggle.textContent = 'On';
                sendCC(103, 127);
            } else {
                effect2Toggle.classList.remove('active');
                effect2Toggle.textContent = 'Off';
                sendCC(103, 0);
            }
            effect2Amount.value = preset.effect2.amount;
            document.getElementById('effect2Value').textContent = preset.effect2.amount;
            sendCC(18, preset.effect2.amount);

            // Apply resonance
            const resonanceAmount = document.getElementById('resonanceAmount');
            resonanceAmount.value = preset.resonance;
            document.getElementById('resonanceValue').textContent = preset.resonance;
            sendCC(86, preset.resonance);
        }

        // Setup preset buttons
        document.querySelectorAll('.preset-btn').forEach(button => {
            button.addEventListener('click', () => {
                const preset = button.dataset.preset;
                applyPreset(preset);
            });
        });

        // Setup device selection
        document.getElementById('midiOutput').addEventListener('change', (e) => {
            selectOutput(e.target.value);
        });

        // Back button
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Initialize on load
        initMIDI();
    </script>
</body>
</html>
