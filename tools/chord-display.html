<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Display - MIDI Tools</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    
    <style>
        .chord-display-section {
            padding: 20px;
        }
        
        .device-group {
            margin-bottom: 20px;
        }
        
        .device-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .device-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }
        
        .chord-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .chord-name {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            min-height: 80px;
            display: flex;
            align-items: center;
        }
        
        .chord-notes {
            font-size: 1.5em;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .chord-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chord-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .note-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .note-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .midi-status {
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            margin: 20px;
        }
        
        .midi-status.connected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .settings-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .setting-item {
            margin-bottom: 10px;
        }
        
        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .back-navigation {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .placeholder-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="chordDisplay.title">üéº Chord Display</h1>
                    <p data-i18n="chordDisplay.subtitle">Real-time jazz chord detection from MIDI input</p>
                </div>
            </div>
        </header>

        <main>
            <div class="back-navigation">
                <button id="backBtn" class="btn btn-secondary" data-i18n="tools.backToTools">‚Üê Back to Tools</button>
            </div>

            <div class="midi-status" id="midiStatus">
                <strong data-i18n="chordDisplay.midiStatus">MIDI Status:</strong> <span id="statusText" data-i18n="chordDisplay.initializing">Initializing...</span>
            </div>

            <div class="chord-display-section">
                <section class="device-group">
                    <label for="midiInput" data-i18n="chordDisplay.inputDevice">MIDI Input Device:</label>
                    <select id="midiInput" aria-label="Select MIDI input device">
                        <option value="" data-i18n="chordDisplay.noDeviceSelected">No device selected</option>
                    </select>
                </section>

                <div class="chord-display" role="region" aria-atomic="true">
                    <div class="chord-name" id="chordName">
                        <span class="placeholder-text" data-i18n="chordDisplay.playNotes">Play some notes...</span>
                    </div>
                    <div class="chord-notes" id="chordNotes"></div>
                </div>

                <div class="chord-info">
                    <h3 id="currentNotesHeading" data-i18n="chordDisplay.currentNotes">Current Notes:</h3>
                    <div class="note-list" id="noteList" aria-labelledby="currentNotesHeading">
                        <span style="color: #999;" data-i18n="chordDisplay.noNotesPlaying">No notes being played</span>
                    </div>
                </div>
                
                <!-- Hidden div exclusively for screen reader chord announcements -->
                <div class="sr-only" role="status" aria-live="assertive" aria-atomic="true" id="chordAnnouncement"></div>

                <div class="settings-section">
                    <h3 data-i18n="chordDisplay.settings">Settings</h3>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showAllChords" checked>
                            <span data-i18n="chordDisplay.showAllChords">Show all possible chord interpretations</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="simplifyChords">
                            <span data-i18n="chordDisplay.simplifyChords">Simplify chord names (prefer basic chords)</span>
                        </label>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Web MIDI Streamer | <a href="https://github.com/denizsincar29/web_midi_streamer" target="_blank" rel="noopener">GitHub</a></p>
        </footer>
    </div>

    <!-- No external dependencies needed - using built-in chord detection -->

    <script type="module">
        import { t, getCurrentLanguage } from '../src/i18n.js';
        
        let midiAccess = null;
        let selectedInput = null;
        let activeNotes = new Set(); // Set of active MIDI note numbers
        let lastChordName = ''; // Store last chord name for screen reader announcement
        let notesWereActive = false; // Track if notes were previously active
        let chordDebounceTimer = null; // Timer for debouncing chord announcements
        
        // MIDI note number to note name mapping (using flats by default for jazz notation)
        const NOTE_NAMES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        
        function midiNoteToName(midiNote) {
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = NOTE_NAMES[midiNote % 12];
            return noteName + octave;
        }
        
        // Chord detection algorithm
        const CHORD_PATTERNS = {
            // Major chords
            '0,4,7': 'Major',
            '0,4': 'Major',
            '0,3,7': 'Minor',
            '0,3': 'Minor',
            '0,3,6': 'Diminished',
            '0,4,8': 'Augmented',
            
            // Seventh chords (with and without fifth)
            '0,4,7,11': 'Major 7',
            '0,4,11': 'Major 7',
            '0,4,7,10': '7',
            '0,4,10': '7',
            '0,3,7,10': 'Minor 7',
            '0,3,10': 'Minor 7',
            '0,3,6,10': 'Half-diminished 7',
            '0,3,6,9': 'Diminished 7',
            '0,3,7,11': 'Minor-Major 7',
            
            // Ninth chords (natural 9)
            '0,4,7,10,14': '9',
            '0,4,10,14': '9',
            '0,4,7,11,14': 'Major 9',
            '0,4,11,14': 'Major 9',
            '0,3,7,10,14': 'Minor 9',
            '0,3,10,14': 'Minor 9',
            
            // Altered ninth chords (b9 and #9)
            '0,4,7,10,13': '7b9',
            '0,4,10,13': '7b9',
            '0,4,7,10,15': '7#9',
            '0,4,10,15': '7#9',
            '0,3,7,10,13': 'Minor 7b9',
            '0,3,10,13': 'Minor 7b9',
            
            // Eleventh chords
            '0,4,7,10,14,17': '11',
            '0,4,10,14,17': '11',
            '0,3,7,10,14,17': 'Minor 11',
            '0,3,10,14,17': 'Minor 11',
            '0,4,7,11,14,18': 'Major 11',
            
            // Sharp eleventh (lydian)
            '0,4,7,10,14,18': '7#11',
            '0,4,10,14,18': '7#11',
            '0,4,7,11,14,18': 'Major 7#11',
            '0,4,11,14,18': 'Major 7#11',
            
            // Thirteenth chords
            '0,4,7,10,14,21': '13',
            '0,4,10,14,21': '13',
            '0,4,7,10,14,17,21': '13',
            '0,3,7,10,14,21': 'Minor 13',
            '0,4,7,11,14,21': 'Major 13',
            
            // Flat thirteenth
            '0,4,7,10,14,20': '7b13',
            '0,4,10,14,20': '7b13',
            
            // Sus chords
            '0,5,7': 'Sus4',
            '0,2,7': 'Sus2',
            '0,5,7,10': '7sus4',
            '0,2,7,10': '7sus2',
            
            // Add chords
            '0,4,7,9': '6',
            '0,4,9': '6',
            '0,4,7,14': 'Add9',
            '0,3,7,9': 'Minor 6',
            '0,3,9': 'Minor 6',
            '0,3,7,14': 'Minor Add9',
            
            // Sixth-ninth chords
            '0,4,7,9,14': '6/9',
            '0,4,9,14': '6/9',
            '0,3,7,9,14': 'Minor 6/9',
        };
        
        function detectChordFromIntervals(intervals) {
            const key = intervals.join(',');
            return CHORD_PATTERNS[key];
        }
        
        function getPitchClass(noteName) {
            // Remove octave number (e.g., "C4" -> "C")
            return noteName.replace(/[0-9]/g, '');
        }
        
        function noteNameToSemitone(noteName) {
            const NOTE_VALUES = {
                'C': 0, 
                'C#': 1, 'Db': 1,  // C# and Db are enharmonic equivalents
                'D': 2, 
                'D#': 3, 'Eb': 3,  // D# and Eb are enharmonic equivalents
                'E': 4, 
                'F': 5,
                'F#': 6, 'Gb': 6,  // F# and Gb are enharmonic equivalents
                'G': 7, 
                'G#': 8, 'Ab': 8,  // G# and Ab are enharmonic equivalents
                'A': 9, 
                'A#': 10, 'Bb': 10, // A# and Bb are enharmonic equivalents
                'B': 11
            };
            return NOTE_VALUES[noteName] || 0;
        }
        
        function detectChord(noteNames) {
            if (noteNames.length < 2) {
                return null;
            }
            
            // Get pitch classes (notes without octaves)
            const pitchClasses = noteNames.map(getPitchClass);
            
            // Remove duplicates
            const uniquePitches = [...new Set(pitchClasses)];
            
            if (uniquePitches.length < 2) {
                return { root: uniquePitches[0], type: 'Single note' };
            }
            
            // Try each note as potential root
            for (let i = 0; i < uniquePitches.length; i++) {
                const root = uniquePitches[i];
                const rootValue = noteNameToSemitone(root);
                
                // Calculate intervals from this root
                const intervals = uniquePitches.map(note => {
                    const value = noteNameToSemitone(note);
                    return (value - rootValue + 12) % 12;
                }).sort((a, b) => a - b);
                
                // Check if this matches a known chord pattern
                const chordType = detectChordFromIntervals(intervals);
                if (chordType) {
                    return { root, type: chordType };
                }
            }
            
            // No match found - return the notes as a custom voicing
            return { root: uniquePitches[0], type: 'Custom', notes: uniquePitches };
        }

        // Initialize MIDI
        async function initMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                updateMIDIStatus(t('chordDisplay.accessGranted'), true);
                populateInputDevices();
                midiAccess.onstatechange = populateInputDevices;
            } catch (error) {
                updateMIDIStatus(t('chordDisplay.accessDenied') + ' ' + error.message, false);
            }
        }

        function updateMIDIStatus(message, connected) {
            const statusEl = document.getElementById('midiStatus');
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusEl.className = connected ? 'midi-status connected' : 'midi-status';
        }

        function populateInputDevices() {
            const select = document.getElementById('midiInput');
            select.innerHTML = `<option value="">${t('chordDisplay.noDeviceSelected')}</option>`;
            
            const inputs = Array.from(midiAccess.inputs.values());
            inputs.forEach((input, index) => {
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = input.name;
                if (index === 0) option.selected = true;
                select.appendChild(option);
            });

            // Auto-select first device
            if (inputs.length > 0) {
                selectInput(inputs[0].id);
            }
        }

        function selectInput(deviceId) {
            // Disconnect previous input
            if (selectedInput) {
                selectedInput.onmidimessage = null;
            }
            
            if (deviceId && midiAccess) {
                selectedInput = midiAccess.inputs.get(deviceId);
                selectedInput.onmidimessage = handleMIDIMessage;
                updateMIDIStatus(t('chordDisplay.connectedTo') + ' ' + selectedInput.name, true);
            } else {
                selectedInput = null;
                updateMIDIStatus(t('chordDisplay.noDevice'), false);
            }
        }

        function handleMIDIMessage(event) {
            const [status, note, velocity] = event.data;
            const command = status & 0xF0;
            
            // Note On
            if (command === 0x90 && velocity > 0) {
                activeNotes.add(note);
                updateDisplay();
            }
            // Note Off
            else if (command === 0x80 || (command === 0x90 && velocity === 0)) {
                activeNotes.delete(note);
                updateDisplay();
            }
        }

        function updateDisplay() {
            const noteListEl = document.getElementById('noteList');
            const chordNameEl = document.getElementById('chordName');
            const chordNotesEl = document.getElementById('chordNotes');
            const chordAnnouncementEl = document.getElementById('chordAnnouncement');
            
            if (activeNotes.size === 0) {
                // When no notes are being played, show the last chord but indicate notes have been released
                noteListEl.innerHTML = `<span style="color: #999;">${t('chordDisplay.noNotesPlaying')}</span>`;
                
                // Keep showing the last chord name if we have one
                if (lastChordName) {
                    // Don't change the chord display - keep showing last chord
                    // Announce the chord name one final time when all notes are released
                    if (notesWereActive) {
                        chordAnnouncementEl.textContent = lastChordName;
                        notesWereActive = false;
                    }
                } else {
                    chordNameEl.innerHTML = `<span class="placeholder-text">${t('chordDisplay.playNotes')}</span>`;
                    chordNotesEl.textContent = '';
                }
                return;
            }
            
            // Mark that we have notes
            notesWereActive = true;
            
            // Convert MIDI notes to note names
            const noteNames = Array.from(activeNotes)
                .sort((a, b) => a - b)
                .map(midiNoteToName);
            
            // Display active notes
            noteListEl.innerHTML = noteNames
                .map(note => `<span class="note-badge">${note}</span>`)
                .join('');
            
            // Detect chords with debouncing for screen reader
            detectAndDisplayChord(noteNames);
        }

        function detectAndDisplayChord(noteNames) {
            const chordNameEl = document.getElementById('chordName');
            const chordNotesEl = document.getElementById('chordNotes');
            const chordAnnouncementEl = document.getElementById('chordAnnouncement');
            
            if (noteNames.length < 1) {
                chordNameEl.innerHTML = `<span class="placeholder-text">${t('chordDisplay.playNotes')}</span>`;
                chordNotesEl.textContent = '';
                return;
            }
            
            // Clear any existing debounce timer
            if (chordDebounceTimer) {
                clearTimeout(chordDebounceTimer);
            }
            
            if (noteNames.length === 1) {
                // Single note
                const pitchClass = getPitchClass(noteNames[0]);
                const singleNoteText = `${pitchClass}`;
                chordNameEl.textContent = singleNoteText;
                chordNotesEl.textContent = t('chordDisplay.singleNote');
                lastChordName = singleNoteText;
                // Debounce announcement for single notes too
                chordDebounceTimer = setTimeout(() => {
                    chordAnnouncementEl.textContent = singleNoteText;
                }, 300);
                return;
            }
            
            // Detect chord
            const chordInfo = detectChord(noteNames);
            
            if (!chordInfo) {
                const notesText = noteNames.map(getPitchClass).join(' ');
                chordNameEl.textContent = notesText;
                chordNotesEl.textContent = t('chordDisplay.customVoicing');
                lastChordName = notesText;
                // Debounce announcement
                chordDebounceTimer = setTimeout(() => {
                    chordAnnouncementEl.textContent = notesText;
                }, 300);
                return;
            }
            
            if (chordInfo.type === 'Custom') {
                chordNameEl.style.fontSize = '3em';
                const customText = chordInfo.notes.join(' ');
                chordNameEl.textContent = customText;
                chordNotesEl.textContent = t('chordDisplay.customVoicing');
                lastChordName = customText;
                // Debounce announcement
                chordDebounceTimer = setTimeout(() => {
                    chordAnnouncementEl.textContent = customText;
                }, 300);
            } else {
                chordNameEl.style.fontSize = '4em';
                const chordFullName = `${chordInfo.root} ${chordInfo.type}`;
                chordNameEl.textContent = chordFullName;
                const pitchClasses = noteNames.map(getPitchClass);
                const uniquePitches = [...new Set(pitchClasses)];
                chordNotesEl.textContent = uniquePitches.join(' - ');
                lastChordName = chordFullName;
                // Debounce announcement - only announce after 300ms of no new notes
                chordDebounceTimer = setTimeout(() => {
                    chordAnnouncementEl.textContent = chordFullName;
                }, 300);
            }
        }
        
        // Update page translations
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update select option
            const selectOption = document.querySelector('#midiInput option[value=""]');
            if (selectOption) {
                selectOption.textContent = t('chordDisplay.noDeviceSelected');
            }
            
            // Update lang attribute
            document.documentElement.lang = getCurrentLanguage();
        }

        // Setup device selection
        document.getElementById('midiInput').addEventListener('change', (e) => {
            selectInput(e.target.value);
        });

        // Setup settings
        document.getElementById('showAllChords').addEventListener('change', updateDisplay);
        document.getElementById('simplifyChords').addEventListener('change', updateDisplay);

        // Back button
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            updateTranslations();
            initMIDI();
        });
    </script>
</body>
</html>
